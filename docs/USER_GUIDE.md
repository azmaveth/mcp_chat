# MCP Chat User Guide

Welcome to MCP Chat, an Elixir-based chat client that supports multiple Large Language Model (LLM) backends and the Model Context Protocol (MCP) for extensible functionality.

## Table of Contents

1. [Getting Started](#getting-started)
2. [Configuration](#configuration)
3. [Using MCP Chat](#using-mcp-chat)
4. [CLI Commands](#cli-commands)
5. [MCP Server Integration](#mcp-server-integration)
6. [Session Management](#session-management)
7. [Advanced Features](#advanced-features)
8. [Troubleshooting](#troubleshooting)

## Getting Started

### Installation

1. Ensure you have Elixir 1.15+ installed
2. Clone the repository
3. Install dependencies:
   ```bash
   mix deps.get
   ```
4. Build the application:
   ```bash
   mix compile
   ```

### First Run

Run MCP Chat with:
```bash
mix mcp_chat
```

Or with options:
```bash
mix mcp_chat --config path/to/config.toml --backend anthropic
```

### Command Line Options

- `-c, --config PATH` - Path to configuration file (default: `~/.config/mcp_chat/config.toml`)
- `-b, --backend NAME` - LLM backend to use (anthropic, openai, local)
- `-h, --help` - Show help message

## Configuration

MCP Chat uses TOML format for configuration. The default config file is created at `~/.config/mcp_chat/config.toml` on first run.

### Basic Configuration

```toml
[llm]
default = "anthropic"  # Default LLM backend

[llm.anthropic]
api_key = "YOUR_API_KEY"  # Or use ANTHROPIC_API_KEY env var
model = "claude-sonnet-4-20250514"
max_tokens = 4096

[llm.openai]
api_key = "YOUR_API_KEY"  # Or use OPENAI_API_KEY env var
model = "gpt-4"
max_tokens = 4096

[ui]
theme = "dark"
history_size = 1000
```

### Environment Variables

API keys can be set via environment variables:
- `ANTHROPIC_API_KEY` - Anthropic API key
- `OPENAI_API_KEY` - OpenAI API key

Environment variables take precedence over config file values.

### MCP Server Configuration

Configure MCP servers in your config file:

```toml
[mcp]
servers = [
  { name = "filesystem", command = ["npx", "-y", "@modelcontextprotocol/server-filesystem", "/tmp"] },
  { name = "github", command = ["npx", "-y", "@modelcontextprotocol/server-github"] }
]
```

## Using MCP Chat

### Basic Chat

Simply type your message and press Enter to send it to the configured LLM:

```
You: Hello, how can you help me today?
Assistant: I'm Claude, an AI assistant. I can help you with a wide variety of tasks...
```

### Multi-line Input

For multi-line messages, use Shift+Enter or paste multi-line text.

### Streaming Responses

Responses are streamed in real-time, showing text as it's generated by the LLM.

## CLI Commands

MCP Chat supports various slash commands for control and configuration:

### General Commands

- `/help` - Show all available commands
- `/exit` or `/quit` - Exit the application
- `/clear` - Clear the chat display
- `/new` - Start a new chat session
- `/history [n]` - Show last n messages (default: 10)

### Session Management

- `/save [name]` - Save current session
- `/load <name|number>` - Load a saved session
- `/sessions` - List all saved sessions
- `/export [format] [path]` - Export session (format: json|markdown)

### Configuration Commands

- `/config` - Show current configuration
- `/backend <name>` - Switch LLM backend (anthropic, openai)
- `/model <name>` - Switch to a different model

### Context Management

- `/context` - Show context statistics and settings
- `/system <prompt>` - Set or update system prompt
- `/tokens [max]` - Set maximum token limit
- `/strategy <name>` - Set truncation strategy (sliding_window, smart)
- `/cost` - Display current session cost

### MCP Server Commands

- `/servers` - List connected MCP servers
- `/discover` - Discover available MCP servers
- `/connect <name>` - Connect to an MCP server
- `/disconnect <name>` - Disconnect from an MCP server

### MCP Tool Commands

- `/tools [server]` - List available tools
- `/tool <server> <tool> [args]` - Execute a tool

### MCP Resource Commands

- `/resources [server]` - List available resources
- `/resource <server> <uri>` - Read a resource

### MCP Prompt Commands

- `/prompts [server]` - List available prompts
- `/prompt <server> <name> [args]` - Get a prompt

### Custom Aliases

- `/alias <name> <command1> [command2...]` - Create command alias
- `/alias <name>` - Show alias definition
- `/alias` - List all aliases
- `/alias remove <name>` - Remove an alias

Example:
```
/alias morning /new /system "You are a helpful morning assistant" Hello! What's on the agenda today?
```

## MCP Server Integration

### Quick Setup

Use the discover command to find and connect to popular MCP servers:

```
/discover
/connect filesystem
```

### Manual Connection

1. List available servers: `/servers`
2. Connect to a server: `/connect github`
3. Use server tools: `/tool github list_repos owner=anthropics`

### Using MCP Tools

After connecting to an MCP server, you can:

1. List available tools:
   ```
   /tools filesystem
   ```

2. Execute a tool:
   ```
   /tool filesystem read_file path=/tmp/test.txt
   ```

3. Tools can also be invoked automatically during conversation when relevant.

## Session Management

### Saving Sessions

Save your conversation for later:
```
/save project-discussion
```

### Loading Sessions

Load by name:
```
/load project-discussion
```

Load by number from session list:
```
/sessions
/load 3
```

### Exporting Sessions

Export to JSON:
```
/export json chat-backup.json
```

Export to Markdown:
```
/export markdown conversation.md
```

## Advanced Features

### Context Window Management

MCP Chat automatically manages context to fit within token limits:

- View current context usage: `/context`
- Set custom token limit: `/tokens 8192`
- Choose truncation strategy:
  - `/strategy sliding_window` - Keep most recent messages
  - `/strategy smart` - Keep system prompt, initial context, and recent messages

### Cost Tracking

Track API usage costs:
- View current session cost: `/cost`
- Costs are calculated based on model pricing
- Token usage is tracked automatically

### Command Aliases

Create shortcuts for common command sequences:

```
/alias gpt /backend openai /model gpt-4-turbo
/alias claude4 /backend anthropic /model claude-sonnet-4-20250514
```

Use aliases:
```
/gpt  # Switches to GPT-4 Turbo
/claude4  # Switches to Claude 4
```

### Conversation Templates

Use system prompts to set conversation context:
```
/system You are an expert Elixir developer. Provide concise, idiomatic code examples.
```

## Troubleshooting

### Common Issues

1. **"API key not configured"**
   - Set your API key in the config file or environment variable
   - Check with `/config` command

2. **"Failed to connect to MCP server"**
   - Ensure the server command is correct
   - Check if required npm packages are installed
   - Try `/discover` for auto-configuration

3. **"Context window exceeded"**
   - Use `/context` to check usage
   - Adjust with `/tokens` or `/strategy`
   - Start a new session with `/new`

### Debug Mode

Set log level in config for debugging:
```toml
[debug]
log_level = "debug"
```

### Getting Help

- Use `/help` for command reference
- Check configuration with `/config`
- View server logs for MCP connection issues

## Tips and Best Practices

1. **Organize Sessions**: Use meaningful names when saving sessions
2. **Manage Context**: Monitor token usage with `/context` for long conversations
3. **Use Aliases**: Create aliases for frequently used command combinations
4. **Export Important Chats**: Regularly export important conversations
5. **Optimize Costs**: Use `/cost` to monitor API usage
6. **Leverage MCP**: Connect relevant MCP servers for enhanced functionality

## Keyboard Shortcuts

- `Ctrl+C` - Cancel current input or stop streaming response
- `Ctrl+D` - Exit application (same as `/exit`)
- `Ctrl+L` - Clear screen (same as `/clear`)
- `Tab` - Autocomplete commands and server names
- `↑/↓` - Navigate command history